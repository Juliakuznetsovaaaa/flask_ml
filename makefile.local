# Makefile.local
.PHONY: help install run run-docker test lint deploy-local clean

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
PORT = 5000
HOST = localhost

help:
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:"
	@echo "  install     - –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
	@echo "  run         - –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ"
	@echo "  run-docker  - –ó–∞–ø—É—Å–∫ –≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ"
	@echo "  test        - –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
	@echo "  test-api    - –ó–∞–ø—É—Å–∫ API —Ç–µ—Å—Ç–æ–≤"
	@echo "  lint        - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –∫–æ–¥–∞"
	@echo "  deploy-local- –î–µ–ø–ª–æ–π –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ localhost"
	@echo "  clean       - –û—á–∏—Å—Ç–∫–∞"

install:
	pip install -r requirements.txt
	pip install pytest pytest-cov flake8 black pylint

run:
	FLASK_ENV=development python run.py

run-docker:
	docker-compose -f docker-compose.local.yml up --build

test:
	python -m pytest tests/ -v --cov=app --cov-report=term-missing

test-api:
	python -m pytest tests/api/ -v

lint:
	flake8 .
	black --check .
	pylint app/

deploy-local: build-local run-local-test validate-local

build-local:
	docker build -t flask-ml-app:local -f Dockerfile.local .

run-local-test:
	@echo "üöÄ –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ localhost..."
	docker run -d --name ml-app-local -p $(PORT):5000 flask-ml-app:local
	sleep 15
	@echo "‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://$(HOST):$(PORT)"

validate-local:
	@echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–ø–ª–æ—è –Ω–∞ localhost..."
	python -c "
import requests
import sys
import json

def check_endpoint(url, name):
    try:
        response = requests.get(url, timeout=10)
        if response.status_code == 200:
            print(f'‚úÖ {name}: –¥–æ—Å—Ç—É–ø–µ–Ω (200 OK)')
            if 'application/json' in response.headers.get('content-type', ''):
                data = response.json()
                print(f'   –û—Ç–≤–µ—Ç: {json.dumps(data, indent=2)}')
            return True
        else:
            print(f'‚ùå {name}: –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ({response.status_code})')
            return False
    except Exception as e:
        print(f'‚ùå {name}: –æ—à–∏–±–∫–∞ - {e}')
        return False

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ endpoints
base_url = 'http://$(HOST):$(PORT)'
endpoints = [
    ('/', '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞'),
    ('/health', 'Health endpoint'),
]

all_ok = True
for endpoint, name in endpoints:
    if not check_endpoint(f'{base_url}{endpoint}', name):
        all_ok = False

if all_ok:
    print('\\nüéâ –í—Å–µ endpoints –¥–æ—Å—Ç—É–ø–Ω—ã!')
    print(f'üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞: http://$(HOST):$(PORT)')
    print('üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ –±—Ä–∞—É–∑–µ—Ä–µ')
else:
    print('\\n‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã')
    sys.exit(1)
"

clean:
	docker stop ml-app-local || true
	docker rm ml-app-local || true
	docker rmi flask-ml-app:local || true
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete