---
name: CI/CD Pipeline for Flask ML Application

"on":
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  FLASK_ENV: test

jobs:
  setup-and-lint:
    name: Setup and Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgl1-mesa-glx \
            libglib2.0-0 \
            libsm6 \
            libxext6 \
            libxrender1

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: >
            ${{ runner.os }}-pip-
            ${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install \
            pytest \
            pytest-flask \
            flake8 \
            pylint \
            black \
            bandit \
            safety

      - name: Check Python security vulnerabilities
        run: |
          safety check --full-report || true

      - name: Lint with flake8
        run: |
          flake8 . --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics

      - name: Check code formatting with black
        run: |
          black --check --diff . || true

      - name: Code analysis with pylint
        run: |
          pylint app/ || true

  simple-run:
    name: Simple Flask + ML Run
    runs-on: ubuntu-latest
    needs: setup-and-lint

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Create test ML model
        run: |
          mkdir -p app/models
          python << 'EOF'
          import tensorflow as tf
          import numpy as np

          model = tf.keras.Sequential([
              tf.keras.layers.InputLayer(
                  input_shape=(299, 299, 3)
              ),
              tf.keras.layers.Conv2D(
                  32,
                  (3, 3),
                  activation="relu"
              ),
              tf.keras.layers.MaxPooling2D(
                  (2, 2)
              ),
              tf.keras.layers.Flatten(),
              tf.keras.layers.Dense(
                  2,
                  activation="softmax"
              ),
          ])

          model.compile(
              optimizer="adam",
              loss="categorical_crossentropy",
              metrics=["accuracy"],
          )

          model.save(
              "app/models/classification_model.h5"
          )

          print("✅ Test model created")
          print(model.input_shape)
          EOF

      - name: Test model loading
        run: |
          python << 'EOF'
          import tensorflow as tf
          import sys

          try:
              model = tf.keras.models.load_model(
                  "app/models/classification_model.h5"
              )
              print("✅ Model loaded")
              print(model.input_shape)
              print(model.output_shape)
          except Exception as exc:
              print(exc)
              sys.exit(1)
          EOF

      - name: Run Flask application
        run: |
          python run.py &
          sleep 10

      - name: Cleanup
        if: always()
        run: |
          pkill -f "python run.py" || true

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: simple-run

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t flask-ml-app:ci-test .

      - name: Test Docker container
        run: |
          docker run -d \
            --name flask-ml-test \
            -p 5002:5000 \
            flask-ml-app:ci-test

          sleep 15
          curl -f http://localhost:5002/health

      - name: Cleanup Docker
        if: always()
        run: |
          docker stop flask-ml-test || true
          docker rm flask-ml-test || true
