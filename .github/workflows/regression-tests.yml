---
name: Regression Testing - Этап 3

"on":
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.9"
  FLASK_ENV: "test"

jobs:

  setup-environment:
    name: Setup Test Environment
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock pillow requests tensorflow

      - name: Create test ML model
        run: |
          mkdir -p app/models
          python - << 'EOF'
          import tensorflow as tf

          model = tf.keras.Sequential([
              tf.keras.layers.InputLayer(input_shape=(299, 299, 3)),
              tf.keras.layers.Flatten(),
              tf.keras.layers.Dense(2, activation="softmax")
          ])

          model.compile(
              optimizer="adam",
              loss="categorical_crossentropy",
              metrics=["accuracy"]
          )

          model.save("app/models/classification_model.h5")
          print("✅ Тестовая модель создана")
          EOF

      - name: Verify test structure
        run: |
          echo "Проверка структуры тестов"
          find tests -name "*.py" | head -20

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    needs: setup-environment

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - run: |
          python -m pytest tests/unit \
            -v \
            --cov=app \
            --cov-report=xml \
            --cov-report=term

  api-tests:
    name: API Tests
    runs-on: ubuntu-22.04
    needs: setup-environment

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov requests

      - run: |
          python -m pytest tests/api \
            -v \
            --cov=app \
            --cov-append \
            --cov-report=xml \
            --cov-report=term

  image-processing-tests:
    name: Image Processing Tests
    runs-on: ubuntu-22.04
    needs: setup-environment

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pillow

      - run: |
          python -m pytest tests/image_processing \
            -v \
            --cov=app.routes \
            --cov-append \
            --cov-report=xml \
            --cov-report=term

  ml-model-tests:
    name: ML Model Tests
    runs-on: ubuntu-22.04
    needs: setup-environment

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov tensorflow

      - run: |
          python -m pytest tests/ml \
            -v \
            --cov=app \
            --cov-append \
            --cov-report=xml \
            --cov-report=term

  mock-tests:
    name: Mock Tests
    runs-on: ubuntu-22.04
    needs: setup-environment

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock

      - run: |
          python -m pytest tests/mock \
            -v \
            --cov=app \
            --cov-append \
            --cov-report=xml \
            --cov-report=term

  test-summary:
    name: Test Summary
    runs-on: ubuntu-22.04
    if: always()
    needs:
      - unit-tests
      - api-tests
      - image-processing-tests
      - ml-model-tests
      - mock-tests

    steps:
      - name: Print summary
        run: |
          echo "✅ Unit: ${{ needs.unit-tests.result }}"
          echo "✅ API: ${{ needs.api-tests.result }}"
          echo "✅ Image: ${{ needs.image-processing-tests.result }}"
          echo "✅ ML: ${{ needs.ml-model-tests.result }}"
          echo "✅ Mock: ${{ needs.mock-tests.result }}"

          if [[ "${{ needs.unit-tests.result }}" != "success" || \
                "${{ needs.api-tests.result }}" != "success" || \
                "${{ needs.image-processing-tests.result }}" != "success" || \
                "${{ needs.ml-model-tests.result }}" != "success" || \
                "${{ needs.mock-tests.result }}" != "success" ]]; then
            exit 1
          fi

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-22.04
    needs: test-summary
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.test-summary.result == 'success'

    steps:
      - name: Deploy
        run: |
          echo "Деплой в production"
          sleep 3
          echo "Деплой завершен"
